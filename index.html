<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>跨年 · 伊犁纪念派对</title>

<style>
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:#05070f;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  overflow:hidden;
}
#app{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
}
button{
  padding:14px 28px;
  font-size:18px;
  border-radius:14px;
  border:none;
  background:linear-gradient(135deg,#ffcc66,#ff9966);
  color:#000;
  cursor:pointer;
}
button:disabled{
  opacity:.6;
}
#hint{
  margin-top:12px;
  font-size:14px;
  opacity:.7;
}
canvas{
  position:fixed;
  inset:0;
  pointer-events:none;
}
.started #enterBox{
  display:none;
}
</style>
</head>

<body>
<div id="app">
  <div id="enterBox">
    <h1>跨年 · 伊犁纪念派对</h1>
    <button id="enterBtn">进入派对 · 解锁音频 & 全屏</button>
    <div id="hint">首次点击用于解锁浏览器权限</div>
  </div>
</div>

<canvas id="fx"></canvas>

<script>
/* =====================
   全局状态
===================== */
let audioDisabled = false;
let started = false;

/* =====================
   背景音乐（可换成本地 mp3）
===================== */
const bgAudio = new Audio();
bgAudio.src = "music.mp3";   // ← 你之后放到仓库的本地 mp3
bgAudio.loop = true;
bgAudio.volume = 0.6;
window.bgAudio = bgAudio;

/* =====================
   点击入口（核心修复点）
===================== */
const enterBtn = document.getElementById('enterBtn');

enterBtn.addEventListener('click', () => {
  if (started) return;
  started = true;

  // ① 立刻反馈（避免“没反应”的错觉）
  enterBtn.innerText = "正在进入…";
  enterBtn.disabled = true;

  // ② 同步请求全屏（成功与否都不影响后续）
  try{
    document.documentElement.requestFullscreen?.();
  }catch(e){}

  // ③ 同步尝试播放音频（允许失败）
  try{
    const p = bgAudio.play();
    if (p && p.catch){
      p.catch(()=>{
        audioDisabled = true;
        console.log("音频加载失败，降级为静音动画");
      });
    }
  }catch(e){
    audioDisabled = true;
  }

  // ④ 无论如何，进入派对
  startParty();
});

/* =====================
   派对主逻辑
===================== */
function startParty(){
  document.body.classList.add("started");
  initCanvas();
  loop();
}

/* =====================
   Canvas 烟花（安全版）
===================== */
const canvas = document.getElementById("fx");
const ctx = canvas.getContext("2d");
let w,h;

function resize(){
  w = canvas.width = window.innerWidth;
  h = canvas.height = window.innerHeight;
}
window.addEventListener("resize",resize);

let particles=[];

function spawnFirework(){
  const cx = w/2 + (Math.random()-0.5)*200;
  const cy = h/2 + (Math.random()-0.5)*200;
  for(let i=0;i<120;i++){
    const a = Math.random()*Math.PI*2;
    particles.push({
      x:cx,y:cy,
      vx:Math.cos(a)*(2+Math.random()*2),
      vy:Math.sin(a)*(2+Math.random()*2),
      life:80
    });
  }
}

function loop(){
  ctx.fillStyle="rgba(0,0,0,0.2)";
  ctx.fillRect(0,0,w,h);

  if(Math.random()<0.04){
    spawnFirework();
  }

  particles.forEach(p=>{
    p.x+=p.vx;
    p.y+=p.vy;
    p.vy+=0.03;
    p.life--;
    ctx.fillStyle="rgba(255,200,120,0.8)";
    ctx.fillRect(p.x,p.y,2,2);
  });

  particles = particles.filter(p=>p.life>0);

  requestAnimationFrame(loop);
}

resize();
</script>
</body>
</html>

